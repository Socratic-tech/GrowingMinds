<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Growing Minds | Educator Portal</title>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    .custom-scroll::-webkit-scrollbar { display: none; }
    .animate-fade-in { animation: fadeIn .3s ease-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to   { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body class="bg-slate-50 font-sans text-gray-900">
<div id="root"></div>

<script type="text/babel">
  const { useState, useEffect } = React;

  // -----------------------------
  // SUPABASE CONFIG
  // -----------------------------
  const SUPABASE_URL = "https://aaiovfryjlcdijdyknik.supabase.co";
  const SUPABASE_KEY = "sb_publishable_cFHXexx3iNPEOWSFZ0IAxQ_h6MuktWT";

  // GitHub Pages Redirect
  const REDIRECT_URL = "https://socratic-tech.github.io/GrowingMinds";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  // ============================================================
  // SECTION 2 ‚Äî AUTH SCREEN (Login / Signup / OAuth / Magic Link)
  // ============================================================

  function AuthScreen() {
    const [email, setEmail] = useState("");
    const [password, setPassword] = useState("");
    const [mode, setMode] = useState("login");

    // ----------------------------
    // Email/Password Login or Signup
    // ----------------------------
    const handleAuth = async (e) => {
      e.preventDefault();

      let result;
      if (mode === "login") {
        result = await supabaseClient.auth.signInWithPassword({
          email,
          password,
        });
      } else {
        result = await supabaseClient.auth.signUp({ email, password });
      }

      if (result.error) alert(result.error.message);
    };

    // ----------------------------
    // Google OAuth Sign-In
    // ----------------------------
    const signInWithGoogle = async () => {
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: "google",
        options: {
          redirectTo: REDIRECT_URL,
        },
      });

      if (error) alert(error.message);
    };

    // ----------------------------
    // Magic Link Sign-In
    // ----------------------------
    const sendMagicLink = async () => {
      if (!email) return alert("Enter your email first!");

      const { error } = await supabaseClient.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: REDIRECT_URL },
      });

      if (error) alert("Error: " + error.message);
      else alert("Magic link sent! Check your inbox.");
    };

    // ----------------------------
    // Render Auth Screen UI
    // ----------------------------
    return (
      <div class="min-h-screen bg-teal-900 flex flex-col items-center justify-center p-8 text-white">

        <i class="fas fa-seedling text-7xl mb-6 text-teal-300"></i>
        <h1 class="text-4xl font-black italic mb-10 uppercase tracking-tighter">
          Growing Minds
        </h1>

        <form onSubmit={handleAuth} class="w-full max-w-xs space-y-4">

          {/* Google OAuth */}
          <button
            type="button"
            onClick={signInWithGoogle}
            class="w-full bg-red-600 hover:bg-red-700 text-white p-4 rounded-2xl font-bold shadow-xl uppercase tracking-widest flex items-center justify-center gap-3 transition"
          >
            <i class="fab fa-google text-lg"></i> Sign in with Google
          </button>

          {/* Divider */}
          <div class="relative py-2 flex items-center">
            <div class="flex-grow border-t border-teal-700"></div>
            <span class="flex-shrink mx-4 text-teal-300 text-[10px] uppercase font-bold tracking-widest">
              Or with email
            </span>
            <div class="flex-grow border-t border-teal-700"></div>
          </div>

          {/* Email/Password Fields */}
          <input
            type="email"
            placeholder="Email"
            class="w-full p-4 rounded-2xl text-gray-900 shadow-xl focus:ring-4 focus:ring-teal-500/50 outline-none"
            onChange={(e) => setEmail(e.target.value)}
            required
          />

          <input
            type="password"
            placeholder="Password"
            class="w-full p-4 rounded-2xl text-gray-900 shadow-xl focus:ring-4 focus:ring-teal-500/50 outline-none"
            onChange={(e) => setPassword(e.target.value)}
            required
          />

          {/* Submit Button */}
          <button class="w-full bg-teal-500 hover:bg-teal-400 py-4 rounded-2xl font-black shadow-xl uppercase tracking-widest transition">
            {mode === "login" ? "Login" : "Join"}
          </button>
        </form>

        {/* Magic Link Button */}
        <div class="w-full max-w-xs mt-6">
          <button
            type="button"
            onClick={sendMagicLink}
            class="w-full py-3 bg-teal-800/50 hover:bg-teal-800 border-2 border-teal-700 rounded-2xl font-bold text-[10px] uppercase tracking-widest text-teal-200 transition"
          >
            <i class="fas fa-magic mr-2"></i>
            Trouble? Email me a Login Link
          </button>
        </div>

        {/* Mode Toggle */}
        <button
          onClick={() => setMode(mode === "login" ? "signup" : "login")}
          class="mt-8 text-xs font-bold underline opacity-80 decoration-teal-300 underline-offset-8"
        >
          {mode === "login"
            ? "New educator? Create an account"
            : "Back to login"}
        </button>

      </div>
    );
  }
  // ============================================================
  // SECTION 3 ‚Äî MAIN APP ROUTER + SESSION MANAGEMENT
  // ============================================================

  function App() {
    const [user, setUser] = useState(null);
    const [profile, setProfile] = useState(null);
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState("feed");
    const [pendingCount, setPendingCount] = useState(0);

    // ---------------------------------------------------------
    // Fetch profile for authenticated user
    // ---------------------------------------------------------
    const fetchProfile = async (authUser) => {
      try {
        const { data } = await supabaseClient
          .from("profiles")
          .select("*")
          .eq("id", authUser.id)
          .single();

        setProfile(data || null);
        setUser(authUser);

        // Admin count badge
        if (data?.role === "admin") {
          fetchPendingCount();
        }

      } catch (error) {
        console.error("Profile fetch error:", error);
      } finally {
        setLoading(false);
      }
    };

    const fetchPendingCount = async () => {
      const { count } = await supabaseClient
        .from("profiles")
        .select("*", { count: "exact", head: true })
        .eq("is_approved", false);

      setPendingCount(count || 0);
    };

    // ---------------------------------------------------------
    // SESSION RESTORE (OAuth + Magic Link)
    // ---------------------------------------------------------
    useEffect(() => {
      const initAuth = async () => {
        try {
          // Consumes OAuth/MagicLink tokens from URL
          await supabaseClient.auth.getSessionFromUrl({ storeSession: true });
        } catch (_) {}

        const { data: { session } } = await supabaseClient.auth.getSession();

        if (session?.user) {
          fetchProfile(session.user);
        } else {
          setLoading(false);
        }
      };

      initAuth();

      // Realtime login/logout listener
      const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(
        (_, session) => {
          if (session?.user) {
            fetchProfile(session.user);
          } else {
            setUser(null);
            setProfile(null);
            setLoading(false);
          }
        }
      );

      return () => subscription.unsubscribe();
    }, []);

    // ---------------------------------------------------------
    // LOADING SCREEN
    // ---------------------------------------------------------
    if (loading) {
      return (
        <div class="h-screen flex items-center justify-center text-teal-600 bg-slate-50">
          <div class="text-center">
            <i class="fas fa-seedling animate-bounce text-5xl mb-4"></i>
            <p class="text-sm font-bold uppercase tracking-widest">
              Loading Growing Minds...
            </p>
          </div>
        </div>
      );
    }

    // ---------------------------------------------------------
    // NOT LOGGED IN ‚Üí Show Auth Screen
    // ---------------------------------------------------------
    if (!user) return <AuthScreen />;

    // ---------------------------------------------------------
    // USER LOGGED IN BUT PROFILE NOT APPROVED
    // ---------------------------------------------------------
    if (!profile || profile.is_approved !== true) {
      return <PendingScreen email={user.email} isNew={!profile} />;
    }

    const isAdmin = profile.role === "admin";

    // ---------------------------------------------------------
    // MAIN APP LAYOUT
    // ---------------------------------------------------------
    return (
      <div class="max-w-md mx-auto min-h-screen bg-white relative shadow-2xl flex flex-col">

        {/* Header */}
        <header class="bg-gradient-to-br from-teal-800 to-emerald-900 p-6 text-white rounded-b-[2.5rem] shadow-lg">
          <div class="flex justify-between items-center mb-6">
            <span class="text-xl font-black italic uppercase tracking-tight">
              Growing Minds
            </span>
            <button
              onClick={() => supabaseClient.auth.signOut()}
              class="text-[10px] bg-white/10 px-3 py-1 rounded-full border border-white/20 font-bold uppercase tracking-widest hover:bg-white/20"
            >
              Logout
            </button>
          </div>

          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-2xl bg-white/20 flex items-center justify-center border border-white/30 text-xl shadow-inner">
              {isAdmin ? "üëë" : "üßë‚Äçüè´"}
            </div>
            <div>
              <p class="text-[10px] text-teal-200 font-bold uppercase tracking-widest">
                {isAdmin ? "Project Lead" : "Educator"}
              </p>
              <p class="font-bold text-lg truncate w-40">
                {user.email.split("@")[0]}
              </p>
            </div>
          </div>
        </header>

        {/* Main Content */}
        <main class="flex-1 p-5 pb-32 overflow-y-auto custom-scroll">
          {activeTab === "feed" && <CommunityFeed user={user} isAdmin={isAdmin} />}
          {activeTab === "library" && <LibraryView isAdmin={isAdmin} />}
          {activeTab === "qa" && <QAView userId={user.id} isAdmin={isAdmin} />}
          {activeTab === "admin" && isAdmin && (
            <AdminPanel onUpdate={fetchPendingCount} />
          )}
        </main>

        {/* Bottom Navigation */}
        <nav class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-white border-t border-slate-100 flex justify-around items-center py-4 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-50 rounded-t-[2rem]">
          <NavBtn icon="home" label="Home" active={activeTab === "feed"} onClick={() => setActiveTab("feed")} />
          <NavBtn icon="book" label="Library" active={activeTab === "library"} onClick={() => setActiveTab("library")} />
          <NavBtn icon="circle-question" label="Ask" active={activeTab === "qa"} onClick={() => setActiveTab("qa")} />
          
          {isAdmin && (
            <div class="relative">
              <NavBtn icon="user-shield" label="Admin" active={activeTab === "admin"} onClick={() => setActiveTab("admin")} />
              {pendingCount > 0 && (
                <span class="absolute -top-1 -right-1 bg-red-500 text-white text-[8px] font-black w-5 h-5 rounded-full flex items-center justify-center border-2 border-white">
                  {pendingCount}
                </span>
              )}
            </div>
          )}
        </nav>

      </div>
    );
  }

  // ============================================================
  // PENDING APPROVAL SCREEN
  // ============================================================
  function PendingScreen({ email, isNew }) {
    return (
      <div class="h-screen bg-slate-50 flex flex-col items-center justify-center p-10 text-center animate-fade-in">
        <div class="w-20 h-20 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center text-3xl mb-6 shadow-inner animate-pulse">
          <i class="fas fa-user-shield"></i>
        </div>

        <h2 class="text-xl font-black text-slate-800 uppercase tracking-tighter mb-2">
          {isNew ? "Creating Profile..." : "Access Restricted"}
        </h2>

        <p class="text-xs text-slate-500 mb-8 leading-relaxed">
          Hi <strong>{email.split("@")[0]}</strong>.<br />
          {isNew
            ? "We are setting up your desk. Refresh in 10 seconds."
            : "An admin is verifying your account."}
        </p>

        <button
          onClick={() => supabaseClient.auth.signOut()}
          class="text-teal-700 font-bold text-[10px] underline uppercase tracking-widest"
        >
          Sign Out
        </button>
      </div>
    );
  }

  // ============================================================
  // NAV BUTTON COMPONENT
  // ============================================================
  function NavBtn({ icon, label, active, onClick }) {
    return (
      <button
        onClick={onClick}
        class={`flex flex-col items-center gap-1.5 px-4 transition-all duration-300 ${
          active ? "text-teal-700 scale-110" : "text-slate-300"
        }`}
      >
        <i class={`fas fa-${icon} text-xl`}></i>
        <span class="text-[9px] font-black uppercase tracking-tighter">
          {label}
        </span>
      </button>
    );
  }
  // ============================================================
  // SECTION 4 ‚Äî Q&A SYSTEM
  // ============================================================

  function QAView({ userId, isAdmin }) {
    const [questions, setQuestions] = useState([]);
    const [title, setTitle] = useState("");
    const [showAsk, setShowAsk] = useState(false);

    // Fetch all existing questions
    const fetchQuestions = async () => {
      const { data } = await supabaseClient
        .from("questions")
        .select("*, profiles(email)")
        .order("created_at", { ascending: false });

      setQuestions(data || []);
    };

    const askQuestion = async (e) => {
      e.preventDefault();
      if (!title) return;

      await supabaseClient.from("questions").insert([
        { user_id: userId, title }
      ]);

      setTitle("");
      setShowAsk(false);
      fetchQuestions();
    };

    useEffect(() => { fetchQuestions(); }, []);

    return (
      <div class="space-y-6">

        {/* Header */}
        <div class="flex justify-between items-center px-1">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-orange-50 text-orange-600 rounded-2xl flex items-center justify-center shadow-sm">
              <i class="fas fa-comments"></i>
            </div>
            <h2 class="text-xl font-black text-slate-800 italic uppercase">Q & A</h2>
          </div>

          <button
            onClick={() => setShowAsk(!showAsk)}
            class="bg-orange-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase shadow-lg tracking-widest"
          >
            {showAsk ? "Close" : "Ask Question"}
          </button>
        </div>

        {/* Ask a Question */}
        {showAsk && (
          <form
            onSubmit={askQuestion}
            class="bg-orange-50 p-6 rounded-[2.5rem] border-2 border-orange-100 animate-fade-in"
          >
            <textarea
              placeholder="What is your question?"
              class="w-full p-4 rounded-2xl border-none shadow-sm text-sm mb-3 h-24"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              required
            />

            <button class="w-full bg-orange-600 text-white font-black py-4 rounded-2xl text-xs uppercase tracking-widest">
              Submit Question
            </button>
          </form>
        )}

        {/* List of Questions */}
        <div class="space-y-4">
          {questions.map((q) => (
            <QuestionCard
              key={q.id}
              question={q}
              userId={userId}
              isAdmin={isAdmin}
            />
          ))}
        </div>

      </div>
    );
  }

  // ------------------------------------------------------------
  // SINGLE QUESTION CARD WITH ANSWERS
  // ------------------------------------------------------------
  function QuestionCard({ question, userId, isAdmin }) {
    const [answers, setAnswers] = useState([]);
    const [newAnswer, setNewAnswer] = useState("");
    const [expanded, setExpanded] = useState(false);

    const fetchAnswers = async () => {
      const { data } = await supabaseClient
        .from("answers")
        .select("*, profiles(email)")
        .eq("question_id", question.id)
        .order("created_at", { ascending: true });

      setAnswers(data || []);
    };

    const postAnswer = async (e) => {
      e.preventDefault();
      if (!newAnswer.trim()) return;

      await supabaseClient.from("answers").insert([
        { question_id: question.id, user_id: userId, content: newAnswer }
      ]);

      setNewAnswer("");
      fetchAnswers();
    };

    // Load answers only when expanded
    useEffect(() => {
      if (expanded) fetchAnswers();
    }, [expanded]);

    return (
      <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden animate-fade-in">

        {/* Question Header */}
        <div class="p-5 cursor-pointer" onClick={() => setExpanded(!expanded)}>
          <div class="flex justify-between items-start gap-4">
            <p class="font-bold text-slate-800 text-sm leading-tight">
              {question.title}
            </p>

            <i class={`fas fa-chevron-${expanded ? "up" : "down"} text-slate-300 text-xs mt-1`}></i>
          </div>

          <div class="mt-3 flex items-center gap-2">
            <span class="text-[9px] font-black uppercase text-orange-600 bg-orange-50 px-2 py-1 rounded-md">
              Question
            </span>

            <span class="text-[9px] text-slate-400 font-bold">
              {question.profiles?.email?.split("@")[0]}
            </span>
          </div>
        </div>

        {/* Expanded: Answers List + Reply Box */}
        {expanded && (
          <div class="bg-slate-50 p-5 border-t border-slate-100 space-y-4">

            {/* Answer Thread */}
            <div class="space-y-3">
              {answers.length === 0 && (
                <p class="text-[10px] text-slate-400 italic">
                  No answers yet. Be the first!
                </p>
              )}

              {answers.map((a) => (
                <div
                  key={a.id}
                  class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100"
                >
                  <p class="text-xs text-slate-700 mb-1">{a.content}</p>
                  <p class="text-[8px] font-black text-teal-600 uppercase">
                    ‚Äî {a.profiles?.email?.split("@")[0]}
                  </p>
                </div>
              ))}
            </div>

            {/* Answer Input */}
            <form onSubmit={postAnswer} class="flex gap-2">
              <input
                placeholder="Your answer..."
                class="flex-1 bg-white border-none rounded-xl px-4 py-2 text-xs shadow-inner"
                value={newAnswer}
                onChange={(e) => setNewAnswer(e.target.value)}
              />

              <button class="bg-teal-700 text-white w-8 h-8 rounded-xl flex items-center justify-center">
                <i class="fas fa-paper-plane text-[10px]"></i>
              </button>
            </form>

          </div>
        )}

      </div>
    );
  }
  // ============================================================
  // SECTION 5 ‚Äî COMMUNITY FEED (POSTS + COMMENTS + IMAGE UPLOAD)
  // ============================================================

  function CommunityFeed({ user, isAdmin }) {
    const [posts, setPosts] = useState([]);
    const [content, setContent] = useState("");
    const [file, setFile] = useState(null);
    const [uploading, setUploading] = useState(false);

    // Load posts
    const fetchPosts = async () => {
      const { data } = await supabaseClient
        .from("posts")
        .select("*, profiles(email)")
        .order("created_at", { ascending: false });

      setPosts(data || []);
    };

    // Upload + create post
    const handleUpload = async (e) => {
      e.preventDefault();
      if (!file && !content) return alert("Write something or pick a photo.");

      setUploading(true);
      try {
        let publicUrl = null;

        // Upload image if present
        if (file) {
          const fileName = `${Date.now()}-${file.name}`;
          const { error: uploadError } = await supabaseClient.storage
            .from("post-image")
            .upload(fileName, file);

          if (uploadError) throw uploadError;

          const { data: urlData } = supabaseClient.storage
            .from("post-image")
            .getPublicUrl(fileName);

          publicUrl = urlData.publicUrl;
        }

        // Insert post
        await supabaseClient.from("posts").insert([
          { user_id: user.id, content, image_url: publicUrl },
        ]);

        // Reset form
        setContent("");
        setFile(null);

        fetchPosts();
      } catch (err) {
        alert("Upload failed: " + err.message);
      }

      setUploading(false);
    };

    // Delete post (admin only)
    const deletePost = async (id) => {
      if (!confirm("Are you sure?")) return;

      await supabaseClient.from("posts").delete().eq("id", id);
      fetchPosts();
    };

    useEffect(() => {
      fetchPosts();
    }, []);

    return (
      <div class="space-y-6">

        {/* Create Post Box */}
        <div class="bg-white p-4 rounded-3xl border-2 border-teal-50 shadow-sm">
          <textarea
            placeholder="Update the garden..."
            class="w-full p-3 text-sm bg-slate-50 rounded-xl border-none focus:ring-2 focus:ring-teal-500 mb-3 resize-none"
            rows="2"
            value={content}
            onChange={(e) => setContent(e.target.value)}
          />

          <div class="flex items-center justify-between">
            {/* Photo Upload */}
            <label class="cursor-pointer bg-teal-50 text-teal-800 px-4 py-2 rounded-xl text-xs font-bold hover:bg-teal-100 transition">
              <i class="fas fa-camera mr-2"></i>
              Photo
              <input
                type="file"
                accept="image/*"
                class="sr-only"
                onChange={(e) => setFile(e.target.files[0])}
              />
            </label>

            {file && (
              <span class="text-[10px] text-teal-600 font-bold truncate max-w-[100px]">
                {file.name}
              </span>
            )}

            <button
              onClick={handleUpload}
              disabled={uploading}
              class="bg-teal-700 text-white px-6 py-2 rounded-xl text-xs font-bold shadow-md hover:bg-teal-800 transition"
            >
              {uploading ? "..." : "Post"}
            </button>
          </div>
        </div>

        {/* Feed Posts */}
        {posts.map((post) => (
          <article
            key={post.id}
            class="bg-white rounded-[2.5rem] border border-slate-100 overflow-hidden shadow-sm mb-6 animate-fade-in relative"
          >
            {/* Admin Delete */}
            {isAdmin && (
              <button
                onClick={() => deletePost(post.id)}
                class="absolute top-4 right-4 bg-red-500 text-white w-8 h-8 rounded-full z-10 flex items-center justify-center shadow-lg hover:bg-red-600 transition"
              >
                <i class="fas fa-trash-can text-[10px]"></i>
              </button>
            )}

            {/* Author Header */}
            <div class="p-4 flex items-center gap-3">
              <div class="w-8 h-8 rounded-full bg-teal-600 flex items-center justify-center text-white text-[10px] font-bold uppercase">
                {post.profiles?.email?.[0]}
              </div>

              <p class="text-xs font-bold">
                {post.profiles?.email?.split("@")[0]}
              </p>
            </div>

            {/* Post Image */}
            {post.image_url && (
              <img
                src={post.image_url}
                class="w-full h-72 object-cover bg-slate-100"
              />
            )}

            {/* Post Body */}
            <div class="p-5">
              <p class="text-sm text-slate-700 leading-relaxed mb-4">
                {post.content}
              </p>

              <CommentSection
                postId={post.id}
                userId={user.id}
                isAdmin={isAdmin}
              />
            </div>
          </article>
        ))}

      </div>
    );
  }

  // ============================================================
  // COMMENT SECTION
  // ============================================================
  function CommentSection({ postId, userId, isAdmin }) {
    const [comments, setComments] = useState([]);
    const [newComment, setNewComment] = useState("");

    const fetchComments = async () => {
      const { data } = await supabaseClient
        .from("comments")
        .select("*, profiles(email)")
        .eq("post_id", postId)
        .order("created_at", { ascending: true });

      setComments(data || []);
    };

    // Add comment
    const handleComment = async (e) => {
      e.preventDefault();
      if (!newComment.trim()) return;

      await supabaseClient.from("comments").insert([
        { post_id: postId, user_id: userId, content: newComment },
      ]);

      setNewComment("");
      fetchComments();
    };

    // Delete comment (admin or owner)
    const deleteComment = async (id) => {
      await supabaseClient.from("comments").delete().eq("id", id);
      fetchComments();
    };

    useEffect(() => {
      fetchComments();
    }, []);

    return (
      <div class="pt-4 border-t border-slate-50 space-y-3">

        {/* All comments */}
        {comments.map((c) => (
          <div key={c.id} class="bg-slate-50 p-3 rounded-2xl relative group">
            <p class="text-[9px] font-black text-teal-700 uppercase mb-1">
              {c.profiles?.email?.split("@")[0]}
            </p>

            <p class="text-xs text-slate-600">{c.content}</p>

            {(isAdmin || c.user_id === userId) && (
              <button
                onClick={() => deleteComment(c.id)}
                class="absolute right-3 top-3 text-[10px] text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"
              >
                <i class="fas fa-times"></i>
              </button>
            )}
          </div>
        ))}

        {/* Add comment */}
        <form onSubmit={handleComment} class="flex gap-2 mt-2">
          <input
            placeholder="Add a comment..."
            class="flex-1 bg-slate-50 border-none rounded-xl px-4 py-2 text-xs focus:ring-1 focus:ring-teal-500"
            value={newComment}
            onChange={(e) => setNewComment(e.target.value)}
          />

          <button class="text-teal-600 px-2">
            <i class="fas fa-paper-plane"></i>
          </button>
        </form>

      </div>
    );
  }
  // ============================================================
  // SECTION 6 ‚Äî LIBRARY (RESOURCES)
  // ============================================================

  function LibraryView({ isAdmin }) {
    const [resources, setResources] = useState([]);
    const [showAdd, setShowAdd] = useState(false);
    const [title, setTitle] = useState("");
    const [url, setUrl] = useState("");
    const [category, setCategory] = useState("Guide");

    // Load resources
    const fetchResources = async () => {
      const { data } = await supabaseClient
        .from("resources")
        .select("*")
        .order("created_at", { ascending: false });

      setResources(data || []);
    };

    // Add a resource
    const handleAdd = async (e) => {
      e.preventDefault();

      await supabaseClient.from("resources").insert([
        { title, url, category },
      ]);

      setTitle("");
      setUrl("");
      setCategory("Guide");
      setShowAdd(false);
      fetchResources();
    };

    // Delete a resource (admin only)
    const handleDelete = async (id) => {
      if (!confirm("Delete this resource?")) return;

      await supabaseClient.from("resources").delete().eq("id", id);
      fetchResources();
    };

    useEffect(() => {
      fetchResources();
    }, []);

    return (
      <div class="space-y-6">

        {/* Header */}
        <div class="flex justify-between items-center px-1">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-teal-50 text-teal-700 rounded-2xl flex items-center justify-center shadow-sm">
              <i class="fas fa-book"></i>
            </div>
            <h2 class="text-xl font-black text-slate-800 italic uppercase">Library</h2>
          </div>

          {/* Toggle Add Form */}
          {isAdmin && (
            <button
              onClick={() => setShowAdd(!showAdd)}
              class="bg-teal-700 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg"
            >
              <i class={`fas fa-${showAdd ? "times" : "plus"}`}></i>
            </button>
          )}
        </div>

        {/* Add Resource Form */}
        {showAdd && (
          <form
            onSubmit={handleAdd}
            class="bg-teal-50 p-6 rounded-[2.5rem] border-2 border-teal-100 space-y-3 animate-fade-in"
          >
            <input
              placeholder="Title"
              class="w-full p-4 rounded-2xl border-none shadow-sm text-sm"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              required
            />

            <input
              placeholder="URL"
              class="w-full p-4 rounded-2xl border-none shadow-sm text-sm"
              value={url}
              onChange={(e) => setUrl(e.target.value)}
              required
            />

            <select
              class="w-full p-4 rounded-2xl border-none shadow-sm text-sm bg-white"
              value={category}
              onChange={(e) => setCategory(e.target.value)}
            >
              <option>Guide</option>
              <option>Curriculum</option>
              <option>Video</option>
              <option>Website</option>
              <option>PDF</option>
            </select>

            <button class="w-full bg-teal-700 text-white font-black py-4 rounded-2xl text-xs uppercase tracking-widest">
              Add Resource
            </button>
          </form>
        )}

        {/* Resource List */}
        <div class="grid gap-4">
          {resources.map((r) => (
            <div
              key={r.id}
              class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between"
            >
              <a
                href={r.url}
                target="_blank"
                class="flex items-center gap-4 flex-1"
              >
                <div class="w-10 h-10 bg-slate-50 text-teal-600 rounded-xl flex items-center justify-center">
                  <i class="fas fa-link"></i>
                </div>

                <div>
                  <p class="text-sm font-bold text-slate-800">{r.title}</p>
                  <p class="text-[9px] font-black text-teal-600 uppercase">
                    {r.category}
                  </p>
                </div>
              </a>

              {/* Delete button for admin */}
              {isAdmin && (
                <button
                  onClick={() => handleDelete(r.id)}
                  class="text-slate-300 hover:text-red-500 p-2"
                >
                  <i class="fas fa-trash-can"></i>
                </button>
              )}
            </div>
          ))}
        </div>

      </div>
    );
  }
  // ============================================================
  // SECTION 7 ‚Äî ADMIN PANEL (USER APPROVAL + ROLES)
  // ============================================================

  function AdminPanel({ onUpdate }) {
    const [users, setUsers] = useState([]);

    // Load all profiles
    const refresh = async () => {
      const { data } = await supabaseClient
        .from("profiles")
        .select("*")
        .order("created_at", { ascending: false });

      setUsers(data || []);
      onUpdate(); // refresh pending count badge
    };

    useEffect(() => {
      refresh();
    }, []);

    // Approve / Unapprove users
    const updateStatus = async (id, field, value) => {
      await supabaseClient
        .from("profiles")
        .update({ [field]: value })
        .eq("id", id);

      refresh();
    };

    const pending = users.filter((u) => !u.is_approved);
    const active = users.filter((u) => u.is_approved);

    return (
      <div class="space-y-6">

        {/* Header */}
        <div class="flex items-center gap-3 px-1">
          <div class="w-10 h-10 bg-slate-900 text-white rounded-2xl flex items-center justify-center shadow-lg">
            <i class="fas fa-user-shield"></i>
          </div>
          <h2 class="text-xl font-black text-slate-800 italic uppercase">
            Control
          </h2>
        </div>

        {/* Pending Accounts */}
        <section class="space-y-3">
          <p class="text-[10px] font-black text-amber-600 px-2 uppercase tracking-widest flex items-center gap-2">
            <i class="fas fa-clock"></i> Pending ({pending.length})
          </p>

          {pending.map((u) => (
            <div
              key={u.id}
              class="p-4 bg-amber-50 border border-amber-100 rounded-[2rem] shadow-sm"
            >
              <p class="text-xs font-black text-slate-800 truncate mb-3">
                {u.email}
              </p>

              <button
                onClick={() => updateStatus(u.id, "is_approved", true)}
                class="w-full py-3 bg-teal-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg hover:bg-teal-700 transition"
              >
                Verify Educator
              </button>
            </div>
          ))}
        </section>

        {/* Active Accounts */}
        <section class="space-y-3">
          <p class="text-[10px] font-black text-slate-400 px-2 uppercase tracking-widest flex items-center gap-2">
            <i class="fas fa-check-circle text-emerald-500"></i> Active ({active.length})
          </p>

          {active.map((u) => (
            <div
              key={u.id}
              class="p-4 bg-white border border-slate-100 rounded-[2rem] shadow-sm flex items-center justify-between"
            >
              <div class="truncate pr-4">
                <p class="text-xs font-bold text-slate-800">{u.email}</p>
                <p class="text-[9px] text-teal-600 font-black uppercase">
                  {u.role}
                </p>
              </div>

              {/* Unapprove */}
              <button
                onClick={() => updateStatus(u.id, "is_approved", false)}
                class="text-slate-300 hover:text-red-500 p-2"
              >
                <i class="fas fa-user-minus"></i>
              </button>
            </div>
          ))}
        </section>

      </div>
    );
  }
  // ============================================================
  // SECTION 8 ‚Äî ROOT RENDER
  // ============================================================

  const root = ReactDOM.createRoot(document.getElementById("root"));
  root.render(<App />);

</script>
</body>
</html>
